services:
  # 1. The PostgreSQL Database
  - type: psql
    name: matcha-database
    plan: free # Use the free tier

  # 2. The Orchestrator Web Service
  - type: web
    name: matcha-orchestrator
    plan: free # Use the free tier
    # Tell Render to use the Dockerfile in the orchestrator directory
    dockerfilePath: ./orchestrator/Dockerfile
    # Tell Render which command to run to start the server
    # We use Gunicorn, a production-ready Python server
    startCommand: "gunicorn -w 4 -b 0.0.0.0:5000 'app:create_app()'"
    # Set the environment variables
    envVars:
      # This tells Python to run our Gunicorn command
      - key: PYTHON_COMMAND
        value: "gunicorn -w 4 -b 0.0.0.0:5000 'app:create_app()'"
        
      # === THIS IS THE CORRECTED BLOCK ===
      - key: DATABASE_URL
        fromService:
          name: matcha-database  # We removed "type: psql" from here
          property: connectionString
      # === END OF CORRECTED BLOCK ===
          
      # Set your secret keys (you can set these as "Secret Files" in Render's dashboard)
      - key: ORCHESTRATOR_API_KEY_PROVIDERS # <-- Fixed typo here
        value: "your-secret-provider-key" 
      - key: ORCHESTRATOR_API_KEY_CONSUMERS
        value: "your-secret-consumer-key"
      - key: SECRET_KEY
        value: "a-very-secret-key"